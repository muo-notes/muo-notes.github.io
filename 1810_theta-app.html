<!doctype html>
<html amp lang="ja">

<head>
    <meta charset="utf-8">
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <title>THETA用の非公式写真転送・シャッターアプリを作ってる</title>
    <link rel="canonical" href="https://notes.muo.jp/1810_theta-app.html" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
        {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "headline": "THETA用の非公式写真転送・シャッターアプリを作ってる",
        "datePublished": "2018-10-08T18:55:00Z",
        "dateModified": "2018-10-08T18:55:00Z",
        "keywords": "",
        "image": [
        ]
      }
    </script>
    <script async custom-element="amp-list" src="https://cdn.ampproject.org/v0/amp-list-0.1.js"></script>
    <script async custom-template="amp-mustache" src="https://cdn.ampproject.org/v0/amp-mustache-0.1.js"></script>
    <script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <style amp-custom>
        .header-img {
            border-bottom: 1px red solid;
        }
        
        .header {
            background-color: red;
            color: white;
            padding: 2px 2px 2px 6px;
        }
        
        .social-buttons {
            padding-top: 4px;
            text-align: center;
        }
        
        amp-social-share[type="b-hatena"] {
            background-image: url(/res/hatenabookmark-logomark.svg);
        }
        
        h2.navigation,
        h3.navigation {
            background-color: #CED6D3;
            margin-left: 6px;
            margin-bottom: 0px;
            padding-left: 16px;
            width: 160px;
            border-radius: 50px 50px 0 0;
        }
        
        .content {
            margin: 0 6px 0px 6px;
            padding: 8px 4px 8px 4px;
            border-radius: 0 0px 2px 2px;
            background-color: #DFE5E8;
        }
        
        h1.subject {
            font-size: 1.5em;
        }
        
        div.content-wrapper {
            text-align: left;
        }
        
        .review-post pre.cmd {
            overflow: auto;
            padding: 8px;
            background-color: black;
            color: #ffffff;
        }
        
        .review-post pre.emlist {
            overflow: auto;
            margin: 8px;
            background-color: #f9f9f9;
        }
        
        .review-post tt.inline-code {
            font-weight: bold;
        }
        
        .review-post br {
            margin: 0px 0px 12px 0px;
            display: block;
            content: " ";
        }
        
        .review-post h2,
        .review-post h3,
        .review-post h4 {
            color: #757EFF;
            border-bottom: 1px solid #000;
            padding-bottom: 0.1em;
        }
        
        .review-post h2 {
            font-size: 1.5em;
        }
        
        .review-post h3 {
            font-size: 1.2em;
        }
        
        .review-post h4 {
            font-size: 1.1em;
        }
        
        .review-post.image p.caption {
            text-align: center;
            margin-bottom: 1em;
        }
        
        .review-post ul li {
            padding: 0px;
        }
        
        .review-post div.footnote ~ h2 {
            margin-top: 1em;
        }
        
        .review-post div.footnote ~ h3 {
            margin-top: 1em;
        }
        
        .review-post div.footnote ~ h4 {
            margin-top: 1em;
        }
        
        .review-post a.noteref {
            vertical-align: super;
        }
        
        pre.list {
            background-color: #def;
            border: 2px dotted;
            padding: 4px;
        }
        
        .review-post div.column {
            margin: 8px;
            padding: 12px;
            background-color: #eeeeee;
            border-radius: 4px;
        }
        
        .review-post blockquote {
            border: 1px solid green;
        }

        @media only screen and (min-width:1119px) {
            nav {
                display: block;
                width: 188px;
                float: left;
            }
        }
        
        @media only screen and (max-width:1118px) {
            nav {
                display: none;
            }
        }

        body {
            background-color: #E4ECEF;
            color: #202121;
        }

        .image {
          width: 60%;
          display: block;
          margin-left: auto;
          margin-right: auto;
        }
    </style>
<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
</head>

<body>
    <div class="content-wrapper">
        <div class="header-img">
            <a href="/"><amp-img media="(max-width: 649px)" src="/res/logo.svg" width=90 height=17></amp-img>
            <amp-img media="(min-width: 650px)" src="/res/logo.svg" width=160 height=30></amp-img></a>
        </div>
        <h1 class="subject">THETA用の非公式写真転送・シャッターアプリを作ってる</h1>
        <div class="content review-post">

<p>週末にやっていたメモがてら。</p>

<h2><span class="secno"></span>THETA（S）と私</h2>
<p>以前某氏から譲っていただいたTHETA Sを愛用している。一時期は旅行へ行ってひたすらTHETAだけで写真を撮るという時期もあった。最近は自分の中でコンデジが復権してきたので出番が少なかったのだけど、遠出する時には旅行鞄へ入れておこうかな、という程度には気持ちが高まってきた。</p>
<p>矢先のことである。</p>

<h2><span class="secno"></span>THETAのAndroidアプリ</h2>
<p>THETAシリーズはスマフォとの連携を前提とするユースケースが多く、撮影した写真は基本的にWi-Fi経由でスマフォへ転送して加工・SNS類へという流れ。</p>
<p>この役目はTHETAアプリとTHETA+アプリのふたつが分担する。</p>
<p>前者がTHETA本体内の写真をWi-Fi経由で転送したりリモートシャッターとしてライブプレビューを見ながらISO値や露出時間を設定して撮影したりという機能を持つ。</p>
<p>後者は転送済み写真を加工するアプリで、様々な効果を加えたり連続した制止画を動画にまとめる機能もある。</p>

<h2><span class="secno"></span>THETAアプリがAndroid 9.0でカメラへ接続できない</h2>
<p>スマフォをEssential PH-1へ買い替えたので一応接続テストをしておくか、と試してみると全然THETAへつながらない。</p>
<p>手持ちの古い端末にはつながるので、差分はOSバージョンだろうと当たりをつけて得た結論はこれ。</p>
<p></p><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">挙動を観察してると、THETA公式アプリはClearText Trafficの許可処理をサボっていてAndroid 9.0では哀れなことにWi-Fi経由のTHETA(192.168.1.1)へのHTTPトラフィックが遮断されてる模様。<br />アプリページでの告知は無し、同様の不具合を訴えてる人は居る <a href="https://t.co/BzihzbzlND">https://t.co/BzihzbzlND</a> <a href="https://twitter.com/hashtag/THETA?src=hash&amp;ref_src=twsrc%5Etfw">#THETA</a> <a href="https://t.co/xFS4LlrPB9">https://t.co/xFS4LlrPB9</a></p>— Kei Nakazawa (@muo_jp) <a href="https://twitter.com/muo_jp/status/1048363420741853184?ref_src=twsrc%5Etfw">2018年10月6日</a></blockquote><script async="async" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Cleartext Traffic対応は<a href="https://developer.android.com/reference/android/security/NetworkSecurityPolicy" class="link">NetworkSecurityPolicy</a>のapplication属性とXMLで処理するのだけど、まだRICOH内で対応してない模様<a id="foobarfnb-cleartext-attr" href="#fn-cleartext-attr" class="noteref">*1</a>。</p>
<div class="footnote" id="foobarfn-cleartext-attr"><p class="footnote">[*1] usesCleartextTraffic属性の一発指定でもなんとかなりそうではある</p></div>
<p>また、Wi-Fiからインターネットに出られるか怪しい際にトラフィックを自動的にLTEや3Gといったモバイル回線へと振り向ける機能とも相性が悪そう。これに関してはTHETAのWi-Fi APへつながった直後に<a href="https://developer.android.com/reference/android/net/ConnectivityManager.html#bindProcessToNetwork(android.net.Network)" class="link">bindProcessToNetwork</a>でアプリのデフォルト経路を設定してやるのが無難だろう。</p>
<p>適切にこの処理をするためには何かしらの方法で接続先Wi-FiのNetworkインスタンスを取得する必要がある。<a href="https://developer.android.com/reference/android/net/ConnectivityManager" class="link">ConnectivityManager</a>に用意されているネットワーク絞り込み用の定数類は明らかにこの用途を満たさないため、自力でNetworkインスタンスを得ることになる。APIをいくらか掘った限りでは残念ながらdeprecatedな要素を利用するしかなかった。WifiInfoあたりにNetworkインスタンスを取得するAPIが生えていればstraightforwardだと思うのだけど。</p>
<p>該当箇所：<a href="https://github.com/muojp/oscsync/blob/5d46fe223cbb3892df444257697f76b655a4ac3d/app/src/main/java/jp/muo/oscsync/OSCConnection.kt#L49" class="link">https://github.com/muojp/oscsync/blob/5d46fe223cbb3892df444257697f76b655a4ac3d/app/src/main/java/jp/muo/oscsync/OSCConnection.kt#L49</a></p>

<h2><span class="secno"></span>OSC APIを調べつつアプリ化</h2>
<p>下調べをできたので、前述のようなネットワーク接続まわりの厄介を一定カバーするようにコードへ落としていった。現状は <a href="https://github.com/muojp/oscsync/" class="link">https://github.com/muojp/oscsync/</a>。</p>
<p>THETAがサポートしているOpen Spherical Camera APIを利用すると、プレビュー取得や写真撮影・各種撮影用設定までWi-Fi経由のHTTPリクエストで完結できる<a id="foobarfnb-is-it-restful" href="#fn-is-it-restful" class="noteref">*2</a>。</p>
<div class="footnote" id="foobarfn-is-it-restful"><p class="footnote">[*2] APIがRESTfulかというとまあHTTP APIという表現のほうが無難だろう</p></div>
<p>Googleが公開している公式ドキュメント：<a href="https://developers.google.com/streetview/open-spherical-camera/?hl=ja" class="link">https://developers.google.com/streetview/open-spherical-camera/?hl=ja</a>優れているのでほぼ迷わない。</p>
<p>OSC APIはLevel 1とLevel 2が定義されており、THETA SはLevel 2対応だと自称するレスポンスを返すのだけど、実際にはLevel 1のみサポートしている（試した範囲では）ところにちょっとハマった。</p>
<p></p><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">やはりTHETA SはAPI Level 1のみ実装しているようなので、撮影はcamera.startSession → camera.takePictureの手順。<br />Wi-Fi接続直後の状態で/osc/stateを叩くとSID_0000が見えるけど、そのまま使うとエラーが戻ってくるのでstartSession必須。<br />しかしcurlだけでﾋﾟﾋｮﾝと鳴らせたので実際勝てる</p>— Kei Nakazawa (@muo_jp) <a href="https://twitter.com/muo_jp/status/1047662303594741760?ref_src=twsrc%5Etfw">2018年10月4日</a></blockquote><script async="async" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>初期調査の段階でここまで試行錯誤できたところでまあ大丈夫だろうと思うに至った。</p>
<p>あとはGenericsを利用するクラスに対して::class.javaを叩きたいとか、suspend functionはasyncキーワードというよりはyieldに近い印象とか、暗黙のitは便利とか、coroutinesの起動用launchは現行仕様だとDispatcherをプログラマに意識させるようになってる（少なくともAndroid Studioは暗黙のlaunch { }に対して文句を言う）のかーとか、最終引数のラムダは引数リスト外へ出す慣習らしい（Swiftもそうらしい）とか、主にKotlinへ馴染みが薄いのをカバーする時間だった。</p>
<div class="column">

<h3><a id="column-1"></a>マイコンとの相性</h3>
<p>ESP8266でリモートシャッターを作るぐらいなら簡単にできる。ESP8266はESP32と比べてメインメモリの少なさが問題になりがちだが、THETA SのAPIは完全にHTTPであり、撮影までに必要なコール回数もかなり少ないため、メモリ上で最低限のJSON処理ができれば十分だろう。</p>
</div>

<h2><span class="secno"></span>先々やりたいこと</h2>
<p>現時点でOSC API Level 1デバイスへの接続・セッション開始・撮影機能はつけたので最低限のリモートシャッターとしては動作する状態になっている。</p>
<p>しかしRICOH THETAは本当に面白いハードウェアで、ついついソフト側でもやりたいことが増えてしまう。</p>

<h3><span class="secno"></span>撮影プロファイルのクイック切り替え</h3>
<p>setOptionというAPIでISO値や露出時間は設定できる。</p>
<p>これ自体は公式のTHETAアプリでもライブプレビューを見ながらできるものだが、個人的には「暗所用の高ISO・短時間露光」「暗所用の低ISO・長時間露光」「日中の低ISO・短時間露光」あたりを自分の好みで数種類用意しておいて撮影時にｼｭｯと設定したいものである。</p>
<p>調べ損なっていたが、一脚とあわせてセルフタイマー撮影も結構楽しいのでアプリ上から楽にモード設定できるとよい（公式THETAアプリではメニュー階層が深くて不便）。</p>

<h3><span class="secno"></span>適切なルールにもとづく写真取り込み</h3>
<p>THETA本体内の写真をいい感じのルールで取り込む仕組みは必要だと思っている。とりわけ、THETAから日々生み出される巨大なJPEGファイルをAndroid端末内にずっと置いておくわけにはいかないので、選別あるいはなんらかのクラウドサービスへと同期してローカル分を削除するのが一般的だろう。</p>

<h3><span class="secno"></span>USB（MTP）経由のクイック取り込み</h3>
<p>個人的には写真枚数が多い場合の高速転送にはUSB（MTP）を使うのが好きで、USBホストアダプタは常時持ち歩いてる族。</p>
<p>THETA Sに関してもAndroid端末へUSB接続してAndroid組み込みのファイルエクスプローラから/Pictures/RICOH THETA/以下へ写真をコピーすることでそれなりの高速・低ストレスを実現できることは確認してある。</p>

最終更新: 2018/10/08 18:55(UTC)
        </div>
        <div class="social-buttons">
            <amp-social-share type="twitter"></amp-social-share>
            <amp-social-share type="b-hatena" width=44 height=44 data-share-endpoint="http://b.hatena.ne.jp/append?CANONICAL_URL"></amp-social-share>
            <amp-social-share type="facebook" data-param-app_id=145634995501895></amp-social-share>
            <amp-social-share type="gplus"></amp-social-share>
        </div>
        <p>Copyright &copy; Kei Nakazawa 2017, Licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.ja">CC-4.0-BY</a>            unless otherwise noted.</p>
    </div>
    <amp-analytics type="googleanalytics" id="muoanalytics">
        <script type="application/json">
        {
            "vars": {"account": "UA-33160231-3"},
            "triggers": { "trackPageview": { "on": "visible", "request": "pageview" } }
        }
        </script>
    </amp-analytics>
</body>

</html>
